unit Core.Types;

interface

uses System.Classes, Generics.Collections, system.SysUtils;

type
  TColumnInfo = record
    ColumnName: string;
    DataType: string;
    IsNullable: string;
    ColumnKey: string;
    Extra: string;
    ColumnDefault: string;
    CharMaxLength: string;
    ColumnComment: string;
  end;

  TIndexColumn = record
    ColumnName: string;
    SeqInIndex: Integer;
  end;

  TIndexInfo = record
    IndexName: string;
    IsUnique: Boolean;
    IsPrimary: Boolean;
    Columns: TArray<TIndexColumn>;
  end;

  TTriggerInfo = record
    TriggerName: string;
    EventManipulation: string;
    ActionTiming: string;
    ActionStatement: string;
    EventObjectTable: string;
  end;

  TTableInfo = class
    TableName: string;
    Columns: TList<TColumnInfo>;
    constructor Create;
    destructor Destroy; override;
  end;

TComparerOptions = class
  public
    NoDelete: Boolean;
    WithTriggers: Boolean;
    WithData: Boolean;
    WithDataDiff: Boolean;
    ExcludeTables: TStringList;
    IncludeTables: TStringList;

    constructor Create;
    destructor Destroy; override;

    // MÉTODO ELEGANTE: La clase sabe cómo crearse a sí misma desde la consola
    class function ParseFromCLI: TComparerOptions;
  end;

implementation

{ TTableInfo }
constructor TTableInfo.Create;
begin
  Columns := TList<TColumnInfo>.Create;
end;

destructor TTableInfo.Destroy;
begin
  Columns.Free;
  inherited;
end;

{ TComparerOptions }

constructor TComparerOptions.Create;
begin
  ExcludeTables := TStringList.Create;
  ExcludeTables.CaseSensitive := False;
  IncludeTables := TStringList.Create;
  IncludeTables.CaseSensitive := False;
end;

destructor TComparerOptions.Destroy;
begin
  ExcludeTables.Free;
  IncludeTables.Free;
  inherited;
end;

class function TComparerOptions.ParseFromCLI: TComparerOptions;
var
  i: Integer;
  Param, Value: string;
begin
  Result := TComparerOptions.Create;
  // Empezamos desde 5 porque 1..4 son conexión
  for i := 5 to ParamCount do
  begin
    Param := LowerCase(ParamStr(i));
    if Param = '--nodelete' then
      Result.NoDelete := True
    else if Param = '--with-triggers' then
      Result.WithTriggers := True
    else if Param = '--with-data' then
      Result.WithData := True
    else if Param = '--with-data-diff' then
      Result.WithDataDiff := True
    else if StartsText('--exclude-tables=', Param) then
    begin
      Value := Copy(ParamStr(i), Length('--exclude-tables=') + 1, MaxInt);
      Result.ExcludeTables.CommaText := Value;
    end
    else if StartsText('--include-tables=', Param) then
    begin
      Value := Copy(ParamStr(i), Length('--include-tables=') + 1, MaxInt);
      Result.IncludeTables.CommaText := Value;
    end;
  end;
  // Validación básica
  if Result.WithData and Result.WithDataDiff then
    raise Exception.Create('Error: No puedes usar --with-data y --with-data-diff a la vez.');
end;

end.