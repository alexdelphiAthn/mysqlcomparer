unit Core.Engine;

interface

uses Core.Interfaces, Core.Types, System.Classes, Core.Helpers;

type
  TDBComparerEngine = class
  private
    FSourceDB: IDBMetadataProvider; // Interfaz, no objeto concreto
    FTargetDB: IDBMetadataProvider; // Interfaz
    FWriter: IScriptWriter;
    FOptions: TComparerOptions;

    procedure CompareTableStructure(const TableName: string);
    procedure CompareTables;
  public
    constructor Create(Source, Target: IDBMetadataProvider;
                       Writer: IScriptWriter; Options: TComparerOptions);
    procedure GenerateScript;
  end;

implementation

uses
  System.SysUtils;

constructor TDBComparerEngine.Create(Source, Target: IDBMetadataProvider;
                                     Writer: IScriptWriter;
                                     Options: TComparerOptions);
begin
  FSourceDB := Source;
  FTargetDB := Target;
  FWriter := Writer;
  FOptions := Options;
end;

procedure TDBComparerEngine.GenerateScript;
begin
  FWriter.AddComment('========================================');
  FWriter.AddComment('SCRIPT DE SINCRONIZACIÓN');
  FWriter.AddComment('Generado: ' + DateTimeToStr(Now));
  FWriter.AddComment('========================================');
  FWriter.AddCommand('');
  CompareTables;
  //CompareViews;
  //CompareProcedures;
  //if FOptions.WithTriggers then
  //  CompareTriggers;
end;

procedure TDBComparerEngine.CompareTables;
begin
//
end;

procedure TDBComparerEngine.CompareTableStructure(const TableName: string);
var
  Table1, Table2: TTableInfo;
  Col1, Col2: TColumnInfo;
  FoundIdx: Integer;

  function FindColumn(List: TList<TColumnInfo>; const Name: string): Integer;
  var
    k: Integer;
  begin
    Result := -1;
    for k := 0 to List.Count - 1 do
      if SameText(List[k].ColumnName, Name) then
        Exit(k);
  end;

begin
  Table1 := FSourceDB.GetTableStructure(TableName);
  Table2 := FTargetDB.GetTableStructure(TableName);
  try
    // ---------------------------------------------------------
    // 1. Recorrer Origen (Table1) para buscar NUEVAS o MODIFICADAS
    // ---------------------------------------------------------
    for var i := 0 to Table1.Columns.Count - 1 do
    begin
      Col1 := Table1.Columns[i];
      FoundIdx := FindColumn(Table2.Columns, Col1.ColumnName);

      if FoundIdx = -1 then
      begin
        // CASO A: La columna no existe en Destino -> CREAR
        FWriter.AddComment('Agregar columna: ' + TableName + '.' + Col1.ColumnName);

        // El Helper se encarga del dialecto SQL (ADD COLUMN vs ADD ...)
        FWriter.AddCommand(FHelpers.GenerateAddColumnSQL(TableName, Col1));
      end
      else
      begin
        // CASO B: La columna existe -> COMPARAR
        Col2 := Table2.Columns[FoundIdx];

        // Usamos la lógica universal del Helper abstracto
        if not FHelpers.ColumnsAreEqual(Col1, Col2) then
        begin
          FWriter.AddComment('Modificar columna: ' + TableName + '.' + Col1.ColumnName);

          // El Helper se encarga del dialecto SQL (MODIFY COLUMN vs ALTER COLUMN...)
          FWriter.AddCommand(FHelpers.GenerateModifyColumnSQL(TableName, Col1));
        end;
      end;
    end;

    // ---------------------------------------------------------
    // 2. Recorrer Destino (Table2) para buscar ELIMINADAS
    // ---------------------------------------------------------
    if not FOptions.NoDelete then
    begin
      for i := 0 to Table2.Columns.Count - 1 do
      begin
        Col2 := Table2.Columns[i];
        FoundIdx := FindColumn(Table1.Columns, Col2.ColumnName);

        if FoundIdx = -1 then
        begin
          // CASO C: La columna sobra en destino -> BORRAR
          FWriter.AddComment('Eliminar columna: ' + TableName + '.' + Col2.ColumnName);

          // El Helper sabe cómo borrar (DROP COLUMN)
          FWriter.AddCommand(FHelpers.GenerateDropColumnSQL(TableName, Col2.ColumnName));
        end;
      end;
    end;

    // ---------------------------------------------------------
    // 3. Comparar Índices (Llamada separada)
    // ---------------------------------------------------------
    CompareTableIndexes(TableName);

  finally
    Table1.Free;
    Table2.Free;
  end;
end;


end;

end.